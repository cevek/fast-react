<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>

<script src="node_modules/t7/t7.js" type="text/javascript"></script>
<script type="text/javascript">

    Node.prototype.setAttr = function (attrName, attrVal) {
        this.setAttribute(attrName, attrVal);
        return this;
    };
    Node.prototype.setStyle = function (attrName, attrVal) {
        this.style[attrName] = attrVal;
        return this;
    };
    Node.prototype.setAttrs = function (attrs) {
        for (var i in attrs) {
            this.setAttribute(i, attrs[i]);
        }
        return this;
    };
    Node.prototype.setRef = function (args, i) {
        args.domNodes[i] = this;
        return this;
    };

    Node.prototype.addValueChild = function (parent, i) {
        norm(parent, i);
        var child = parent.values[i];
        if (child.tag == 'array') {
            for (var i = 0; i < child.children.length; i++) {
                var child_ = child.children[i];
                render(child_, this);
            }
            return this;
        }
        if (child.tag == 'template') {
            render(child, this);
            return this;
        }
        parent.values[i].node = this.appendChild(document.createTextNode(child.children));
        return this;
    };

    Node.prototype.addChild = function (child) {
        if (child instanceof Node) {
            this.appendChild(child);
            return this;
        }
        this.appendChild(document.createTextNode(child));
        return this;
    };

    var t1 = {
        render: function (vdomTemplate, parentNode) {
            vdomTemplate.node = document.createElement('div')
                    .setAttr('class', 'peow')
                    .addChild(document.createElement('div')
                            .setAttrs(vdomTemplate.values[0]).setRef(vdomTemplate, 0)
                            .addValueChild(vdomTemplate, 1).setRef(vdomTemplate, 1))
                    .addChild('Wow')
                    .addValueChild(vdomTemplate, 2).setRef(vdomTemplate, 2)
                    .addChild(document.createElement(vdomTemplate.values[3]).setRef(vdomTemplate, 3)
                            .setAttr('class', vdomTemplate.values[4]).setRef(vdomTemplate, 4)
                            .setStyle('color', vdomTemplate.values[5]).setRef(vdomTemplate, 5)
                            .addChild(1))
            if (parentNode) {
                parentNode.appendChild(vdomTemplate.node);
            }
            return vdomTemplate;
        }, argTypes: [['attrs'], ['children', 0], ['children', 2], ['tag'], ['attr', 'class'], ['style', 'color']]
    };

    var t2 = {
        render: function (vdomTemplate, parentNode) {
            vdomTemplate.node = document.createElement('div')
                    .setAttr('title', 'item ' + vdomTemplate.values[0]).setRef(vdomTemplate, 0)
                    .addChild(document.createElement('span')
                            .addValueChild(vdomTemplate, 1).setRef(vdomTemplate, 1))

            if (parentNode) {
                parentNode.appendChild(vdomTemplate.node);
            }
            return vdomTemplate;
        }, argTypes: [['attr', 'title'], ['children']]
    };

    var k = 0;
    function component() {
        var items = [k++, k++, k++];
        return {
            tag: 'template',
            template: t1,
            node: null,
            values: [{class: 'hey'}, items.map(function (item) {
                return {
                    template: t2,
                    node: null,
                    values: [item, item],
                    domNodes: new Array(2)
                }
            }), 'Hello' + k++, 'div', 'foo' + k++, k % 2 ? 'red' : 'blue'],
            domNodes: new Array(5)
        };
    }

    function render(vdomTemplate, rootNode) {
        return vdomTemplate.template.render(vdomTemplate, rootNode);
    }

    function update(old, vdomTemplate) {
        vdomTemplate.node = old.node;
        if (vdomTemplate.tag !== old.tag) {
            //todo
        }
        else if (vdomTemplate.tag == 'template') {
            for (var i = 0; i < vdomTemplate.values.length; i++) {
                var type = vdomTemplate.template.argTypes[i];
                var dom = vdomTemplate.domNodes[i] = old.domNodes[i];
                var val = vdomTemplate.values[i];
                var oldVal = old.values[i];
                if (type[0] == 'attr') {
                    if (val !== oldVal) {
                        dom.setAttribute(type[1], val);
                    }
                }
                else if (type[0] == 'style') {
                    if (val !== oldVal) {
                        dom.style[type[1]] = val;
                    }
                }
                else if (type[0] == 'attrs') {
                    for (var attr in val) {
                        if (val[attr] !== oldVal[attr]) {
                            this.setAttribute(attr, val[attr]);
                        }
                    }
                }
                else if (type[0] == 'children') {
                    norm(vdomTemplate, i);

                    update(oldVal, vdomTemplate.values[i]);
                }
                else if (type[0] == 'tag') {
                    //todo
                }
            }
        }
        else if (vdomTemplate.tag == '#'){
            if (vdomTemplate.children !== old.children) {
                vdomTemplate.node.textContent = vdomTemplate.children;
            }
        }
        else if (vdomTemplate.tag == 'array'){
            //todo
        }
        return vdomTemplate;
    }

    function replaceChild(old, vdomTemplate, i) {

    }

    function norm(vdom, i) {
        if (vdom.values[i] instanceof Array) {
            vdom.values[i] = {tag: 'array', node: null, children: vdom.values[i]};
            return;
        }
        vdom.values[i] = {tag: '#', node: null, children: vdom.values[i]};
    }

    function updateChild(old, vdomTemplate, i) {
        norm(vdomTemplate, i);

        var val = vdomTemplate.values[i];
        var oldVal = old.values[i];
//        var dom = old.domNodes[i].childNodes[old.template.argTypes[i][1]];
        var dom = old.values[i].node;

        var child = vdomTemplate.values[i];
        if (child.tag == 'template') {
            var node = render(child, this);
            old.domNodes[i].replaceChild(node, dom);
            return this;
        }
    }

    function updateChildren() {

    }

    var node = render(component(), document.body.appendChild(document.createElement('div')));
    console.log(node);

    setTimeout(function () {
        node = update(node, component());
        console.log(node);
    }, 2000);


    /*
        function norm(parent, i) {
            var node = parent.children[i];
            if (typeof node == 'object' && node && typeof node.tag !== 'undefined') {
                return;
            }
            parent.children[i] = {tag: '#', dom: null, children: node};
        }

        function create(vdom, domNodes, parentNode, insertBefore) {
            if (vdom.tag == '#') {
                vdom.dom = document.createTextNode(vdom.children);
                parentNode.insertBefore(vdom.dom, insertBefore);
                return;
            }
            if (typeof vdom.tag == 'string') {
                vdom.dom = document.createElement(vdom.tag);
                setAttrs(vdom);
                setStyle(vdom);
                setRefs(vdom, domNodes);
                parentNode.insertBefore(vdom.dom, insertBefore);
                if (typeof vdom.children !== 'object' && vdom.children !== null) {
                    vdom.dom.textContent = vdom.children;
                    return;
                }
            }
            if (typeof vdom.children !== 'undefined') {
                for (var i = 0; i < vdom.children.length; i++) {
                    norm(vdom, i);
                    create(vdom.children[i], domNodes, vdom.dom, null);
                }
            }
        }


        function setAttrs(vdom) {
            if (typeof vdom.attrs !== 'undefined') {
                for (var i = 0; i < vdom.attrs.length; i += 2) {
                    vdom.dom.setAttribute(vdom.attrs[i], vdom.attrs[i + 1]);
                }
            }
        }

        function setStyle(vdom) {
            if (typeof vdom.style !== 'undefined') {
                for (var i = 0; i < vdom.style.length; i += 2) {
                    vdom.dom.style[vdom.style[i]] = vdom.style[i + 1];
                }
            }
        }

        function setRefs(vdom, domNodes) {
            if (typeof vdom.refs !== 'undefined') {
                for (var i = 0; i < vdom.refs.length; i++) {
                    domNodes[vdom.refs[i]] = vdom.dom;
                }
            }
        }*/



    /*

        var people = [1, 2, 3];
        function abc() {
            return t7`<div><ul> ${ people.map(function (person) { return t7`<li>${ person }</li>` }) }</ul></div>`;
        }
        var res = abc();
        var res = abc();
        console.log(res);
        console.log(JSON.stringify(res, null, 2));

    */

</script>
<!--<script src="dist/index.js" type="text/javascript"></script>-->
</body>
</html>