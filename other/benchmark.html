<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="fps"></div>
<div id="test"></div>
<script src="../node_modules/react/dist/react.min.js" type="text/javascript"></script>
<script src="../dist/index.js" type="text/javascript"></script>
<script src="../fragments/index.js" type="text/javascript"></script>
<style type="text/css">
    .items {
        display: none;
    }

    .item {
        display: inline-block;
        width: 50px;
    }
</style>
<script type="text/javascript">
    /*


     Results                      FastReact      React
     Create 5000                   80/160         9
     Create 5000,2child            45/323         5
     Update 20000                  83/560         8
     Update 20000,2child           42/1000        3
     Update 20000,3child           28/1200        2

     */

    /* console.time('perf');
     for (var i = 0; i < 1000000; i++) {
     var div = document.createElement('div');
     var t = document.createTextNode('wow');
     div.appendChild(t);
     //        div.textContent = 'wow';
     //        div.firstChild;
     }
     console.timeEnd('perf');*/


    var isCreate = location.hash.indexOf('create') > -1;
    console.log(isCreate ? "Create test" : "Update test");

    var twoChilds = location.hash.indexOf('two') > -1;

    var render = React.render;
    var Component = React.Component;
    var createElement = React.createElement;

    if (location.hash.indexOf('react') === -1) {
        render = FastReact.render;
        Component = FastReact.Component;
        createElement = FastReact.createElement;

    }


    var fps = document.getElementById('fps');
    var lastDate = Date.now();
    var fpsItems = [];
    var size = 100;
    var k = 0;
    function tick() {
        var now = Date.now();
        var dur = now - lastDate;
        lastDate = now;
        fpsItems[k++ % size] = dur;
    }

    setInterval(function () {
        var sum = 0;
        for (var i = 0; i < fpsItems.length; i++) {
            sum += fpsItems[i];
        }
        fps.textContent = 1000 / (sum / size) | 0;
    }, 800);


    var count = isCreate ? 5000 : 20000;
    var items = [];
    for (var i = 0; i < count; i++) {
        items.push(i);
    }

    var renderK = 0;

    var fn = function fn(item) {
        return {tag: 'template', node: null, key: item, template: t2, values: [item], domNodes: new Array(1)};
        return {0: item, length: 0, key: item, domNodes: null, template: t2};
    };

    var t1 = {
        render: function (vdom, parentNode) {
            vdom.node = document.createElement('div')
                    .setAttr('class', 'items')
                    .addValueChild(vdom, 0).setRef(vdom, 0);

            if (parentNode) {
                parentNode.appendChild(vdom.node);
            }
            return vdom;
        }, argTypes: [['children', 0]]
    };

    var t2 = {
        render: function (vdom, parentNode) {
            vdom.node = document.createElement('div')
                    .setAttr('class', 'item')
                    .addValueChild(vdom, 0).setRef(vdom, 0)
                    .addChild(2)

            if (parentNode) {
                parentNode.appendChild(vdom.node);
            }
            return vdom;
        }, argTypes: [['children', 0]]
    };

    function component() {
        setTimeout(update);
        renderK++;
        if (renderK % 2 && isCreate) {
//            return createElement('div');
        }
        return {tag: 'template', node: null, template: t1, values: [this.items.map(fn)], domNodes: new Array(1)};
    }

    function update() {
        node = FastReact.update(node, component());
        if (renderK % 2) {
        }
        tick();
    }

    var node = render(component(), document.getElementById('test'));


    function profile() {
        console.profile('perf');
        setTimeout(function () {
            console.profileEnd('perf');
        }, 5000);
    }
</script>
</body>
</html>
